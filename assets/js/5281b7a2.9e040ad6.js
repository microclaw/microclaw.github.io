"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[2443],{936(e,n,t){t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>u,frontMatter:()=>i,metadata:()=>o,toc:()=>a});const o=JSON.parse('{"id":"architecture","title":"Architecture","description":"Data flow","source":"@site/docs/architecture.md","sourceDirName":".","slug":"/architecture","permalink":"/docs/architecture","draft":false,"unlisted":false,"editUrl":"https://github.com/microclaw/microclaw/tree/main/docs/architecture.md","tags":[],"version":"current","sidebarPosition":9,"frontMatter":{"id":"architecture","title":"Architecture","sidebar_position":9},"sidebar":"docs","previous":{"title":"Scheduler","permalink":"/docs/scheduler"},"next":{"title":"Developer Guide","permalink":"/docs/developer-guide"}}');var r=t(4848),s=t(8453);const i={id:"architecture",title:"Architecture",sidebar_position:9},l=void 0,c={},a=[{value:"Data flow",id:"data-flow",level:2},{value:"Key modules",id:"key-modules",level:2},{value:"Agentic loop",id:"agentic-loop",level:2}];function d(e){const n={code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"data-flow",children:"Data flow"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'Telegram message\n       |\n       v\n    Store in SQLite (message + chat metadata)\n       |\n       v\n    Determine response: private=always, group=@mention only\n       |\n       v\n    Start typing indicator (tokio::spawn, every 4s)\n       |\n       v\n    Load history:\n       - Private: last N messages\n       - Group: all messages since last bot response\n       |\n       v\n    Build system prompt (bot identity + memory context + chat_id)\n       |\n       v\n    Agentic loop (up to MAX_TOOL_ITERATIONS):\n       1. Call Claude API with messages + tool definitions\n       2. If stop_reason == "tool_use" -> execute tools -> append results -> loop\n       3. If stop_reason == "end_turn" -> extract text -> return\n       |\n       v\n    Abort typing indicator\n       |\n       v\n    Send response (split if > 4096 chars)\n       |\n       v\n    Store bot response in SQLite\n'})}),"\n",(0,r.jsx)(n.h2,{id:"key-modules",children:"Key modules"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"src/\n    main.rs          # CLI entry point\n    config.rs        # Environment variable loading\n    error.rs         # Error types\n    telegram.rs      # Message handler + agent loop\n    claude.rs        # Anthropic API client\n    db.rs            # SQLite tables + queries\n    memory.rs        # CLAUDE.md memory system\n    scheduler.rs     # Background scheduler\n    tools/           # Tool trait + implementations\n"})}),"\n",(0,r.jsx)(n.h2,{id:"agentic-loop",children:"Agentic loop"}),"\n",(0,r.jsxs)(n.p,{children:["The core logic lives in ",(0,r.jsx)(n.code,{children:"process_with_claude"}),":"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Load history and memory"}),"\n",(0,r.jsx)(n.li,{children:"Call Claude with tool definitions"}),"\n",(0,r.jsxs)(n.li,{children:["If ",(0,r.jsx)(n.code,{children:"stop_reason"})," is ",(0,r.jsx)(n.code,{children:"tool_use"}),", run tools and feed results back"]}),"\n",(0,r.jsxs)(n.li,{children:["If ",(0,r.jsx)(n.code,{children:"end_turn"}),", return the text response"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"The loop is capped to prevent infinite tool chains."})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453(e,n,t){t.d(n,{R:()=>i,x:()=>l});var o=t(6540);const r={},s=o.createContext(r);function i(e){const n=o.useContext(s);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),o.createElement(s.Provider,{value:n},e.children)}}}]);